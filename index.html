<html>
    <head>
        <script lang="javascript" src="xlsx.full.min.js"></script>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div>
            <div class="rows">
                <label>Variables (comma separated)</label>
                <input type="text" id="vars" value="a,b">
            </div>
            <div class="rows">
                <label>Expressions (comma separated)</label>
                <input type="text" id="expression" value="a || b">
            </div>
            <div class="rows">
                <button id="getResult">Generate truth table</button>
            </div>
            <div id="result"></div>
            <div class="rows">
                <button id="exportXLS">Export as XLS (Excel) file</button>
            </div>
            <div>
                    Changelog: Add stuff here
            </div>
        </div>
        <script>
            var vars = ['a','b'] ,expressions = ['! ( a || b || c )'];
            var getResult = document.getElementById('getResult')
            var getXLS = document.getElementById('exportXLS')
            var wb = XLSX.utils.book_new();
            wb.Props = {
                Title: "Truth Table",
                Subject: "TT",
                Author: "AutoGeneratedTT",
                CreatedDate: new Date(2020,20,20)
            };

            getResult.addEventListener('click', output);
            getXLS.addEventListener('click', exportXLS);

            function exportXLS()
            {

            }


            function output()
            {
                var len = vars.length;
                var splitBy = Math.round(len/2);
                var trueSet;
                var trueVals = [];
                var falseVals = [];
                var truthData = [];
                
                vars = document.getElementById('vars').value.split(',');
                expressions = document.getElementById('expression').value.split(',');

                
                truthData.push(truth(vars, vars, true));
                for(var i = 1; i <= splitBy; i++) 
                {
                    trueSet = reduceToCombinations(permut(vars, i));
                    trueSet.forEach((truthSrc)=>
                    {
                        trueVals = truth(vars, truthSrc);
                        truthData.push(trueVals);
                    }
                    );
                }
                truthData.push(truth(vars, vars));
                
                writeTruthTable(truthData);
            }

            function truth(set, truths, reverse) 
            {
                var truthSet = {};
                
                set.forEach(i => truthSet[i] = (truths.indexOf(i) >= 0 ? true : false) ^ reverse);
                
                return truthSet;
            }

            function reduceToCombinations(arr) 
            {
                var i = 1;
                var finalElement;

                arr = arr.map(j => {return j.split('').sort().join('')}).sort();
                
                finalElement = arr[0];
                while(i<arr.length) 
                {
                    if(arr[i] == finalElement) 
                    {
                        arr.splice(i,1);
                    } 
                    else 
                    {
                        finalElement = arr[i];
                        i++;
                    }
                }
                arr = arr.map(j=>{return j.split('')});
                return arr;
            }

            function writeTruthTable(truthData) 
            {
                var table = '<table cellpadding=0 cellspacing=0>';
                var keys;
                var vals;
                var exprRes;
                
                wb.SheetNames.push("TruthTable");
                var ttArr = [...Array(vars.length + expressions.length)].map(x=>Array(9).fill(0))       
                var k = 0;
                table += '<thead><tr>';
                vars.forEach(j =>
                {
                    table += '<th>';
                    table += j;
                    ttArr[k][0] = j;
                    table += '</th>';
                    k += 1;
                });

                expressions.forEach(j =>
                {
                    table += '<th>';
                    table += j;
                    ttArr[k][0] = j;
                    table += '</th>';
                    k += 1;
                });

                table += '</tr></thead>';

                try
                {
                    truthData.forEach((j)=> 
                    {
                        vals = [];
                        keys = [];
                        table += '<tr>';
                        k = 0;
                        l = 1;
                        for(i in j)
                        {
                            vals.push(j[i]);
                            keys.push(i);
                            table += '<td>';
                            table += j[i];
                            ttArr[k][l] = String(j[i]);
                            table += '</td>';
                        };


                        for(var i = 0; i < keys.length; i++) 
                        {
                            eval(`var ${keys[i]} = ${vals[i]};`);
                        }

                        k = vars.length;
                        l = 1;
                        expressions.forEach((expr)=>
                        {
                            exprRes = eval(expr);
                            table += `<td class="${exprRes}">`;
                            table += exprRes ? 'T' : 'F';
                            table += '</td>';
                        });
                        
                        table += '</tr>';
                    });
                }
                catch(err)
                {
                    document.write(err);
                }

                document.write(ttArr);
                table += '</table>';
                document.getElementById('result').innerHTML = table;
            }

            function permut(arr, c) {
                var buf = [];
                var len;
                var arrSlice;
                var permArr;
                var proArr;

                if(c <= 1) 
                {
                    return arr;
                } 
                else 
                {
                    len = arr.length;
                    for(var i=0;i<len;i++) 
                    {
                        arrSlice = arr.slice(0,i).concat(arr.slice(i+1));
                        permArr = permut(arrSlice,c-1);
                        proArr = [];
                        for(var y=0; y<permArr.length; y++) 
                        {
                            proArr.push([arr[i]].concat(permArr[y]).join(''));
                        }
                        buf.push(...proArr);
                    }
                }
                return buf;
            }
        </script>
    </body>
</html>